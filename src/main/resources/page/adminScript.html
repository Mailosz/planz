<script type="module">
    import {PlacementHelper} from './js/utils/PlacementHelper.js';
    import {Popup} from './js/ui/Popup.js';
    import {DocBuilder} from './js/utils/DocBuilder.js';

    window.placeElement = (element, anchor, placement, options) => {
        PlacementHelper.computePosition(element, anchor, placement, options);
    }

    window.Popup = Popup;

    document.builder = new DocBuilder(document);
</script>
<script>
    function changePublic(event) {

        fetch("documents/" + docId + "/change/public/" + event.target.checked + "?token=" + token).then((resp) => {
            return resp.text();
        }).then((text) => {
            if (text == "true") {
                event.target.checked = true;
            } else if (text == "false") {
                event.target.checked = false;
            }
        });

    }

    function changeEditable(event) {

        fetch("documents/" + docId + "/change/editable/" + event.target.checked + "?token=" + token).then((resp) => {
            return resp.text();
        }).then((text) => {
            if (text == "true") {
                event.target.checked = true;
            } else if (text == "false") {
                event.target.checked = false;
            }
        });

    }

    function templateChange(event) {
        fetch("documents/" + docId + "/change/template/" + event.target.options[event.target.selectedIndex].value + "?token=" + token).then((resp) => {
            return resp.text();
        }).then((text) => {
            if (text == "true") {
                location.reload();
            }
        });
    }

    function updateFieldOpts(input) {
        let url = "fields/" + docId + "/" + input.id + "?token=" + token;
        let request = new Request(url, {
            method: "PUT",
            body: input.value,
        });
        fetch(request).then((resp) => {
            if (resp.ok) {
                showResultPopup("success-popup", "Zapisano zmianę");
            } else {
                showResultPopup("fail-popup", "Błąd zapisu");
            }
            console.log(resp);
        });
    };

    function showAdminPopup(fieldId, valueId, event) {
        console.log("FieldId: " + fieldId);
        console.log("ValueId: " + valueId);

        let url = "fields/" + docId + "/" + fieldId + "?token=" + token;
        let request = new Request(url, {
            method: "GET"
        });
        fetch(request).then((resp) => {
            console.log(resp);
            if (resp.ok) {
                return resp.json();
            } else {
                throw resp.status;
            }
        }).then((json) => {

            //show admin popup
            /**
             * @type {DocBuilder} 
             */
            const builder = document.builder;

            let typeSelect, valueInput;

            let content = builder.tag("div").children(
                builder.tag("div").class("admin-popup-row").children(
                    builder.tag("span").class("admin-popup-label").innerText("Nazwa: "),
                    builder.tag("span").class("admin-popup-value").innerText(json.name)
                ),
                builder.tag("div").class("admin-popup-row").children(
                    builder.tag("span").class("admin-popup-label").innerText("Wartość domyslna: "),
                    builder.tag("span").class("admin-popup-value").innerText(json.defaultValue)
                ),
                builder.tag("div").class("admin-popup-row").children(
                    builder.tag("label").class("admin-popup-label").innerText("Wartość: ").attr("for", "admin-popup-value-input"),
                    valueInput = builder.tag("input").id("admin-popup-value-input").class("admin-popup-value").attr("value", json.value?json.value:"")
                ),
                builder.tag("div").class("admin-popup-row").children(
                    builder.tag("label").class("admin-popup-label").innerText("Typ pola: ").attr("for", "admin-popup-type-select"),
                    typeSelect = builder.tag("select").id("admin-popup-type-select").class("admin-popup-value").children(
                        builder.tag("option").attr("value", "TEXT").innerText("Wartość tekstowa"),
                        builder.tag("option").attr("value", "CODE").innerText("Kod"),
                        builder.tag("option").attr("value", "AUTO").innerText("Pole automatyczne"),
                        builder.tag("option").attr("value", "COPY").innerText("Kopiuj"),
                        builder.tag("option").attr("value", "COMP").innerText("Kompilowane")
                    ).forEveryChild((el) => {if (json.type == el.value) el.selected = true; })
                ),
                builder.tag("div").class("admin-popup-row").attr("style", "text-align: right;").children(
                    builder.tag("span").attr("style", "text-decoration: underline; color: darkblue; cursor: pointer;").innerText("Historia zmian")
                ),
                builder.tag("div").class("admin-popup-row").children(
                    builder.tag("button").innerText("Zapisz").event("click", (event) => {
                        let popup = Popup.getPopupOfElement(event.target);
                        //send field update
                        let request = new Request(url, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({type: typeSelect.getTag().options[typeSelect.getTag().selectedIndex].value})
                        });
                        fetch(request).then((resp) => {
                            if (resp.ok) {
                                showResultPopup("success-popup", "Wykonano");
                                popup.hide();
                            } else {
                                showResultPopup("fail-popup", "Błąd");
                            }
                            console.log(resp);
                        });
                    })
                )
            ).getTag();


            let popup = new Popup(content, {});
            popup.show(event.target, "rightIn bottomOut");

        }).catch((error) => {
            showResultPopup("fail-popup", "Błąd otwierania ( " + error + " )");
        });


    }


    /**
     * updates everything
     */
    function update() {
        let url = "update?token=" + token;
        let request = new Request(url, {
            method: "POST",
        });
        fetch(request).then((resp) => {
            if (resp.ok) {
                showResultPopup("success-popup", "Wykonano");
            } else {
                showResultPopup("fail-popup", "Błąd");
            }
            console.log(resp);
        });
    }
</script>