<script>
    var timeouts = {};

    var token = document.getElementById("token-input").value;
    var docId = document.getElementById("document-id-input").value;

    function cancelTimeout(name) {
        let timeout = timeouts[name];
        if (timeout != null) {
            clearTimeout(timeout);
        }
        timeouts[name] = null;
    }

    function resetTimeout(name, func) {
        cancelTimeout(name);
        timeouts[name] = setTimeout(() =>{func(); timeouts[name] = null;}, 1000);
    };

    function updateFieldValue(input) {
        let url = "values/" + docId + "/" + input.id + "?token=" + token;
        let request = new Request(url, {
            method: "PUT",
            body: input.value,
        });
        fetch(request).then((resp) => {
            if (resp.ok) {
                showResultPopup("success-popup", "Zapisano zmianę");
            } else {
                showResultPopup("fail-popup", "Błąd zapisu");
            }
            console.log(resp);
        });
    };

    function fieldInput(event) {
        resetTimeout(event.target.getAttribute("name"), () => updateFieldValue(event.target))
    }

    function fieldChange(event) {
        cancelTimeout(event.target.getAttribute("name"));
        updateFieldValue(event.target);
    }


    function showResultPopup(className, content) {
        let popup = document.createElement("div");
        popup.classList.add(className);
        popup.innerHTML = content;
        popup.onanimationend = (event) => document.body.removeChild(popup);
        document.body.appendChild(popup);
    }
</script>