<script>
    var timeouts = {};

    var token = document.getElementById("token-input").value;
    var docId = document.getElementById("document-id-input").value;

    function cancelTimeout(name) {
        let timeout = timeouts[name];
        if (timeout != null) {
            clearTimeout(timeout);
        }
        timeouts[name] = null;
    }

    function resetTimeout(name, func) {
        cancelTimeout(name);
        timeouts[name] = setTimeout(() =>{func(); timeouts[name] = null;}, 1500);
    };

    function updateFieldValue(input) {
        let url = "values/" + docId + "/" + input.id + "?token=" + token;
        let request = new Request(url, {
            method: "PUT",
            body: input.value,
        });
        fetch(request).then((resp) => {
            if (resp.ok) {
                showResultPopup("success-popup", "Zapisano zmianę");
            } else {
                showResultPopup("fail-popup", "Błąd zapisu");
            }
            console.log(resp);
        });
    };

    function fieldInput(event) {
        resetTimeout(event.target.getAttribute("name"), () => updateFieldValue(event.target))
    }

    function fieldChange(event) {
        checkInput(event.target); 
        cancelTimeout(event.target.getAttribute("name"));
        updateFieldValue(event.target);
    }


    function showResultPopup(className, content) {
        let popup = document.createElement("div");
        popup.classList.add(className);
        popup.innerHTML = content;
        popup.onanimationend = (event) => document.body.removeChild(popup);
        document.body.appendChild(popup);
    }

    function checkInput(input) {
        console.log("here")
        
        let datalist = input.list;
        if (datalist == null) {
            input.classList.remove("unknown");
            return;
        }

        let value = input.value.toUpperCase();
        if (value == "") {
            input.classList.remove("unknown");
            return;
        }

        for (let option of datalist.options) {
            if (value == option.value.toUpperCase()) {
                
                input.classList.remove("unknown");

                return;
            }
        }
        input.classList.add("unknown");
    }

    let elems = document.querySelectorAll(".edit-hud input[type=text].user-editable-field");

        for (let elem of elems) {
            checkInput(elem);
        }

    document.body.addEventListener("load", (event) => {
        
    });
</script>